import{p as q,d as $e,r as E,c as Le,w as je,o as Ae,E as n,a as le,b as Oe,e as Ke,f as x,g as j,h as y,i as r,j as d,F as de,k as Fe,u as o,l as Be,m as h,t as H,n as P,q as Z,s as We,v as Ue,x as Qe,y as Ne,z as X,A as De,_ as ye,B as Xe,C as Ye,D as re,G as Pe,H as Ge,I as we,J as Ve,K as Ze,L as ae,M as se,N as ze,O as ge,P as eu,Q as uu,R as Me,S as tu}from"./index.2a2c50c9.js";import{c as au}from"./printElementProvider.242eb2b9.js";async function Je(s,F){try{const c=await q.base.getTableById(s),v=await(await c.getViewById(F)).getVisibleFieldIdList();return await Promise.all(v.map(async f=>{const g=await c.getFieldById(f);return{id:f,name:await g.getName(),type:g.type}}))}catch(c){throw console.error("\u83B7\u53D6\u5B57\u6BB5\u4FE1\u606F\u65F6\u51FA\u9519:",c),c}}const ce=s=>{if(Array.isArray(s)&&s.length>0){const F=s[0];if(!F||typeof F!="object")return F;if(F.type&&F.type.includes("image"))return F.token;if("id"in F||F.type==="text")return F.text}return s},He=(s,F)=>{if(s===null)return"\u7A7A";switch(F){case 1:return ce(s);case 2:return s;case 3:return s.text;case 4:return s.text;case 5:return new Date(s).toLocaleString();case 7:return s;case 11:return s;case 13:return s;case 15:return s;case 17:return ce(s);case 18:return s.text;case 19:return ce(s);case 20:return ce(s);case 21:return s;case 22:return s;case 23:return s;case 1001:return new Date(s).toLocaleString();case 1002:return new Date(s).toLocaleString();case 1003:return s.map(c=>c.name).join(",");case 1004:return s.map(c=>c.name).join(",");case 1005:return s&&s.status==="completed"?s.value:s;case 99001:return ce(s);case 99002:return s;case 99003:return s;case 99004:return s;case 99005:return s;default:return s}};async function Ie(s,F=3,c=1e3){try{return await s()}catch(D){if(F===0)throw D;return await new Promise(v=>setTimeout(v,c)),Ie(s,F-1,c)}}async function Ee(s,F,c=null,D=!1,v=null){try{const w=await q.base.getTableById(s),g=await(await w.getViewById(F)).getVisibleFieldIdList(),O=await Promise.all(g.map(async b=>{const R=await w.getFieldById(b);return{id:b,name:await R.getName(),type:R.type}}));if(c){const b=[];for(const V of O)try{const k=await w.getFieldById(V.id),N=await Ie(async()=>{try{return await k.getValue(c)}catch(G){throw console.warn(`\u83B7\u53D6\u5B57\u6BB5 ${V.id} \u7684\u503C\u5931\u8D25\uFF0C\u6B63\u5728\u91CD\u8BD5...`,G),G}}),M=D?He(N,V.type):null;b.push({name:V.name,value:D?M:N,type:V.type,field:V.id})}catch(k){console.warn(`\u83B7\u53D6\u5B57\u6BB5 ${V.id} \u7684\u503C\u5931\u8D25:`,k),b.push({name:V.name,value:null,type:V.type,field:V.id})}const R=[{recordId:c,field:b}];return v&&typeof v=="function"&&v(R),R}const A=[];let B=null,S=!0,_=0;for(;S;){_++;const b=await w.getRecords({pageSize:200,pageToken:B,viewId:F}),{records:R,pageToken:V}=b,k=R.map(async G=>{try{const K=[];for(const J of O)try{const Q=await w.getFieldById(J.id),p=await Ie(async()=>{try{return await Q.getValue(G.recordId)}catch($){throw console.warn(`\u83B7\u53D6\u5B57\u6BB5 ${J.id} \u7684\u503C\u5931\u8D25\uFF0C\u6B63\u5728\u91CD\u8BD5...`,$),$}}),i=D?He(p,J.type):null;K.push({name:J.name,value:D?i:p,type:J.type,field:J.id})}catch(Q){console.warn(`\u83B7\u53D6\u5B57\u6BB5 ${J.id} \u7684\u503C\u5931\u8D25:`,Q),K.push({name:J.name,value:null,type:J.type,field:J.id})}return{recordId:G.recordId,field:K}}catch(K){return console.warn("\u5904\u7406\u8BB0\u5F55\u65F6\u51FA\u9519:",K),null}}),M=(await Promise.all(k)).filter(Boolean);A.push(...M),v&&typeof v=="function"&&v(A.slice(),_,!V),S=!!V,B=V}return A}catch(w){throw console.error("\u83B7\u53D6\u8BB0\u5F55\u548C\u5B57\u6BB5\u503C\u65F6\u51FA\u9519:",w),w}}async function nu(s){try{return(await(await q.base.getTableById(s)).getFieldMetaList()).filter(v=>v.type===17)}catch(F){throw console.error("\u83B7\u53D6\u9644\u4EF6\u5B57\u6BB5\u5931\u8D25:",F),F}}async function lu(s,F=1){try{if(!window.pdfjsLib)throw new Error("PDF.js \u5E93\u672A\u52A0\u8F7D");const c=await s.arrayBuffer(),v=await window.pdfjsLib.getDocument({data:c}).promise;if(F<1||F>v.numPages)throw new Error(`\u65E0\u6548\u7684\u9875\u7801: ${F}\uFF0C\u6587\u6863\u5171\u6709 ${v.numPages} \u9875`);const w=await v.getPage(F),f=window.devicePixelRatio||2,g=w.getViewport({scale:f}),O=document.createElement("canvas"),A=O.getContext("2d");O.width=g.width,O.height=g.height;const B={canvasContext:A,viewport:g};return await w.render(B).promise,new Promise((S,_)=>{try{O.toBlob(b=>{b?S(b):_(new Error("\u8F6C\u6362\u4E3ABlob\u5931\u8D25"))},"image/jpeg",1)}catch(b){_(b)}})}catch(c){throw console.error("PDF\u8F6C\u56FE\u7247\u5931\u8D25:",c),c}}async function ru(s,F,c=1){try{const D=await lu(s,c);return new File([D],`${F}.jpg`,{type:"image/jpeg"})}catch(D){throw console.error("PDF\u8F6C\u56FE\u7247\u6587\u4EF6\u5931\u8D25:",D),D}}const ou={class:"print-data-selector"},iu={class:"field-selection"},su={key:0,class:"data-preview"},cu={class:"data-preview-header"},du={class:"record-count"},Fu={class:"count-number"},pu={class:"count-number"},mu={class:"pagination-container"},fu={class:"action-buttons"},gu={key:0},vu={class:"format-selection",style:{"margin-top":"15px"}},Bu={key:1,class:"export-progress"},Du={class:"dialog-footer"},xe=200,wu=$e({__name:"PrintDataSelector",props:{hiprintTemplate:{},initialFields:{},initialRecords:{}},emits:["print"],setup(s,{emit:F}){const c=s,D=F,v=E([]),w=E([]),f=E([]),g=E([]),O=E(!1),A=E(null),B=E(1),S=E(20),_=Le(()=>{const a=(B.value-1)*S.value;return f.value.slice(a,a+S.value)}),b=Le(()=>w.value.length===0?v.value.slice(0,4):v.value.filter(a=>w.value.includes(a.id)));je(()=>c.initialFields,a=>{a&&a.length>0&&(v.value=a,w.value=a.slice(0,4).map(t=>t.id))},{immediate:!0}),je(()=>c.initialRecords,a=>{a&&a.length>0&&(f.value=a)},{immediate:!0}),Ae(async()=>{(!c.initialFields||c.initialFields.length===0)&&await V()});function R(a){return a==null?"":Array.isArray(a)?a.join(", "):typeof a=="object"?JSON.stringify(a):String(a)}async function V(){try{const a=await q.base.getActiveTable(),t=await a.getActiveView(),e=a.id,u=t.id;v.value=await Je(e,u),w.value=v.value.slice(0,4).map(l=>l.id)}catch(a){console.error("\u83B7\u53D6\u5B57\u6BB5\u4FE1\u606F\u5931\u8D25:",a),n.error("\u83B7\u53D6\u5B57\u6BB5\u4FE1\u606F\u5931\u8D25: "+(a.message||String(a)))}}async function k(){O.value=!0,f.value=[],g.value=[],B.value=1;try{const a=await q.base.getActiveTable(),t=await a.getActiveView(),e=a.id,u=t.id,l=await Ee(e,u,xe,!0);f.value=l.map(m=>{const T={recordId:m.recordId,field:m.field};return m.field&&m.field.forEach(L=>{T[L.field]=L.value}),T}),l.length>=xe?n.warning(`\u5DF2\u83B7\u53D6 ${l.length} \u6761\u8BB0\u5F55\uFF0C\u8FBE\u5230\u6700\u5927\u9650\u5236 ${xe} \u6761`):n.success(`\u5DF2\u83B7\u53D6 ${l.length} \u6761\u8BB0\u5F55`)}catch(a){console.error("\u83B7\u53D6\u8BB0\u5F55\u6570\u636E\u5931\u8D25:",a),n.error("\u83B7\u53D6\u8BB0\u5F55\u6570\u636E\u5931\u8D25: "+(a.message||String(a)))}finally{O.value=!1}}function N(a){g.value=a}function M(a){S.value=a,B.value=1,A.value&&A.value.clearSelection()}function G(a){B.value=a,A.value&&setTimeout(()=>{A.value.clearSelection(),_.value.forEach(t=>{g.value.some(e=>e.recordId===t.recordId)&&A.value.toggleRowSelection(t,!0)})},0)}function K(){if(g.value.length===0){n.warning("\u8BF7\u5148\u9009\u62E9\u8981\u6253\u5370\u7684\u6570\u636E");return}try{const a=Q();D("print",a),n.success("\u5DF2\u53D1\u9001\u6253\u5370\u8BF7\u6C42")}catch(a){console.error("\u51C6\u5907\u6253\u5370\u6570\u636E\u5931\u8D25:",a),n.error("\u51C6\u5907\u6253\u5370\u6570\u636E\u5931\u8D25: "+(a.message||String(a)))}}function J(){if(g.value.length===0){n.warning("\u8BF7\u5148\u9009\u62E9\u8981\u5BFC\u51FA\u7684\u6570\u636E");return}try{const a=Q();D("print",a,!0),n.success("\u5DF2\u53D1\u9001PDF\u5BFC\u51FA\u8BF7\u6C42")}catch(a){console.error("\u51C6\u5907\u5BFC\u51FA\u6570\u636E\u5931\u8D25:",a),n.error("\u51C6\u5907\u5BFC\u51FA\u6570\u636E\u5931\u8D25: "+(a.message||String(a)))}}function Q(){return g.value.map(a=>{const t={...a};delete t.recordId,delete t.field;const e={};return Object.keys(t).forEach(u=>{e[u]=t[u]}),e.table=[t],e})}function p(){A.value&&(A.value.clearSelection(),f.value.forEach(a=>{A.value.toggleRowSelection(a,!0)}),g.value=[...f.value])}function i(){if(A.value){_.value.forEach(t=>{A.value.toggleRowSelection(t,!1)}),_.value.forEach(t=>{A.value.toggleRowSelection(t,!0)});const a=g.value.filter(t=>!_.value.some(e=>e.recordId===t.recordId));g.value=[...a,..._.value]}}function $(){A.value&&(A.value.clearSelection(),g.value=[])}function C(){if(A.value){A.value.clearSelection(),_.value.forEach(u=>{const l=g.value.some(m=>m.recordId===u.recordId);A.value.toggleRowSelection(u,!l)});const a=_.value,t=g.value.filter(u=>!a.some(l=>l.recordId===u.recordId)),e=a.filter(u=>!g.value.some(l=>l.recordId===u.recordId));g.value=[...t,...e]}}const I=E([]),U=E(""),ee=E(!1),oe=E(0),ie=E(0),te=E(0),Y=E(!1),ne=E("pdf");async function Ce(){try{const t=(await q.base.getActiveTable()).id,e=await nu(t);I.value=e,e.length>0&&(U.value=e[0].id)}catch(a){console.error("\u83B7\u53D6\u9644\u4EF6\u5B57\u6BB5\u5931\u8D25:",a),n.error("\u83B7\u53D6\u9644\u4EF6\u5B57\u6BB5\u5931\u8D25: "+(a.message||String(a)))}}async function he(){if(g.value.length===0){n.warning("\u8BF7\u5148\u9009\u62E9\u8981\u5BFC\u51FA\u7684\u6570\u636E");return}if(await Ce(),I.value.length===0){n.warning("\u5F53\u524D\u8868\u683C\u4E2D\u6CA1\u6709\u9644\u4EF6\u7C7B\u578B\u5B57\u6BB5\uFF0C\u8BF7\u5148\u6DFB\u52A0\u9644\u4EF6\u5B57\u6BB5");return}ee.value=!0}async function be(){if(!U.value){n.warning("\u8BF7\u9009\u62E9\u4E00\u4E2A\u9644\u4EF6\u5B57\u6BB5");return}try{Y.value=!0,oe.value=0,ie.value=g.value.length,te.value=0;const t=await(await q.base.getActiveTable()).getFieldById(U.value);for(const e of g.value){te.value++;try{const u=pe(e),l=await Se(u);if(!l)throw new Error("\u751F\u6210PDF\u5931\u8D25");const m=`\u8BB0\u5F55_${e.recordId}_${new Date().toISOString().split("T")[0]}`;let T;ne.value==="pdf"?T=new File([l],`${m}.pdf`,{type:"application/pdf"}):T=await ru(l,m),await t.setValue(e.recordId,T),oe.value=te.value/ie.value*100,await new Promise(L=>setTimeout(L,300))}catch(u){console.error(`\u5904\u7406\u8BB0\u5F55 ${e.recordId} \u5931\u8D25:`,u),n.warning(`\u5904\u7406\u8BB0\u5F55 ${e.recordId} \u5931\u8D25: ${u.message||String(u)}`)}}n.success(`\u5DF2\u6210\u529F\u5BFC\u51FA ${te.value} \u6761\u8BB0\u5F55\u7684${ne.value==="pdf"?"PDF":"JPEG\u56FE\u7247"}\u5230\u591A\u7EF4\u8868\u683C`),ee.value=!1}catch(a){console.error("\u5BFC\u51FA\u81F3\u591A\u7EF4\u8868\u683C\u5931\u8D25:",a),n.error("\u5BFC\u51FA\u81F3\u591A\u7EF4\u8868\u683C\u5931\u8D25: "+(a.message||String(a)))}finally{Y.value=!1}}function pe(a){const t={...a};delete t.recordId,delete t.field;const e={};return Object.keys(t).forEach(u=>{e[u]=t[u]}),e.table=[t],e}async function Se(a){return new Promise((t,e)=>{try{if(!c.hiprintTemplate){e(new Error("\u6253\u5370\u6A21\u677F\u672A\u521D\u59CB\u5316"));return}const u=`\u8BB0\u5F55_${new Date().toISOString().split("T")[0]}`;c.hiprintTemplate.toPdf([a],u,{isDownload:!1,type:"blob"}).then(l=>{l instanceof Blob?t(l):(console.error("PDF\u751F\u6210\u7ED3\u679C\u4E0D\u662FBlob\u5BF9\u8C61:",l),e(new Error("\u751F\u6210PDF\u5931\u8D25\uFF0C\u672A\u8FD4\u56DEBlob\u5BF9\u8C61")))}).catch(l=>{console.error("\u751F\u6210PDF\u5931\u8D25:",l),e(l||new Error("\u751F\u6210PDF\u5931\u8D25"))})}catch(u){console.error("\u751F\u6210PDF\u8FC7\u7A0B\u51FA\u9519:",u),e(u)}})}return(a,t)=>{const e=le,u=Oe,l=Ke;return x(),j("div",ou,[t[26]||(t[26]=y("h3",null,"\u6253\u5370\u6570\u636E\u9009\u62E9",-1)),y("div",iu,[t[7]||(t[7]=y("h4",null,"\u9009\u62E9\u8868\u683C\u663E\u793A\u5B57\u6BB5",-1)),r(o(Be),{modelValue:w.value,"onUpdate:modelValue":t[0]||(t[0]=m=>w.value=m),multiple:"","collapse-tags":"","collapse-tags-tooltip":"",placeholder:"\u8BF7\u9009\u62E9\u8981\u663E\u793A\u7684\u5B57\u6BB5",style:{width:"100%"}},{default:d(()=>[(x(!0),j(de,null,Fe(v.value,m=>(x(),X(o(De),{key:m.id,label:m.name,value:m.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),f.value.length>0?(x(),j("div",su,[y("div",cu,[t[14]||(t[14]=y("h4",null,"\u9009\u62E9\u6253\u5370\u8BB0\u5F55",-1)),y("div",du,[t[12]||(t[12]=h(" \u603B\u8BB0\u5F55: ")),y("span",Fu,H(f.value.length),1),t[13]||(t[13]=h(" | \u5DF2\u9009\u62E9: ")),y("span",pu,H(g.value.length),1),r(o(P),{type:"text",size:"small",onClick:p,class:"select-btn"},{default:d(()=>t[8]||(t[8]=[h("\u5168\u9009")])),_:1,__:[8]}),r(o(P),{type:"text",size:"small",onClick:i,class:"select-btn"},{default:d(()=>t[9]||(t[9]=[h("\u9009\u62E9\u5F53\u524D\u9875")])),_:1,__:[9]}),r(o(P),{type:"text",size:"small",onClick:$,class:"select-btn"},{default:d(()=>t[10]||(t[10]=[h("\u53D6\u6D88\u5168\u9009")])),_:1,__:[10]}),r(o(P),{type:"text",size:"small",onClick:C,class:"select-btn"},{default:d(()=>t[11]||(t[11]=[h("\u53CD\u9009")])),_:1,__:[11]})])]),r(u,{ref_key:"dataTable",ref:A,data:_.value,style:{width:"100%"},height:"400px",onSelectionChange:N},{default:d(()=>[r(e,{type:"selection",width:"55"}),(x(!0),j(de,null,Fe(b.value,m=>(x(),X(e,{key:m.id,prop:m.id,label:m.name,width:m.width||120},{default:d(T=>[h(H(R(T.row[m.id])),1)]),_:2},1032,["prop","label","width"]))),128))]),_:1},8,["data"]),y("div",mu,[r(l,{"current-page":B.value,"onUpdate:currentPage":t[1]||(t[1]=m=>B.value=m),"page-size":S.value,"onUpdate:pageSize":t[2]||(t[2]=m=>S.value=m),"page-sizes":[10,20,50,100,200],layout:"total, sizes, prev, pager, next, jumper",total:f.value.length,onSizeChange:M,onCurrentChange:G},null,8,["current-page","page-size","total"])])])):Z("",!0),y("div",fu,[r(o(P),{type:"primary",onClick:k,loading:O.value},{default:d(()=>t[15]||(t[15]=[h("\u83B7\u53D6\u6570\u636E")])),_:1,__:[15]},8,["loading"]),r(o(P),{type:"success",onClick:K,disabled:g.value.length===0},{default:d(()=>t[16]||(t[16]=[h("\u6253\u5370\u9009\u4E2D\u6570\u636E")])),_:1,__:[16]},8,["disabled"]),r(o(P),{type:"warning",onClick:J,disabled:g.value.length===0},{default:d(()=>t[17]||(t[17]=[h("\u5BFC\u51FAPDF")])),_:1,__:[17]},8,["disabled"]),r(o(P),{type:"info",onClick:he,disabled:g.value.length===0},{default:d(()=>t[18]||(t[18]=[h("\u5BFC\u51FA\u81F3\u591A\u7EF4\u8868\u683C")])),_:1,__:[18]},8,["disabled"])]),r(o(Ne),{modelValue:ee.value,"onUpdate:modelValue":t[6]||(t[6]=m=>ee.value=m),title:"\u5BFC\u51FA\u81F3\u591A\u7EF4\u8868\u683C",width:"500px","close-on-click-modal":!1,"close-on-press-escape":!1},{footer:d(()=>[y("span",Du,[r(o(P),{onClick:t[5]||(t[5]=m=>ee.value=!1),disabled:Y.value},{default:d(()=>t[25]||(t[25]=[h("\u53D6\u6D88")])),_:1,__:[25]},8,["disabled"]),r(o(P),{type:"primary",onClick:be,loading:Y.value,disabled:Y.value},{default:d(()=>[h(H(Y.value?"\u5BFC\u51FA\u4E2D...":"\u5F00\u59CB\u5BFC\u51FA"),1)]),_:1},8,["loading","disabled"])])]),default:d(()=>[Y.value?(x(),j("div",Bu,[y("p",null,"\u6B63\u5728\u5BFC\u51FA\u81F3\u591A\u7EF4\u8868\u683C ("+H(te.value)+"/"+H(ie.value)+")",1),r(o(Qe),{percentage:oe.value,format:m=>`${m}%`},null,8,["percentage","format"])])):(x(),j("div",gu,[t[22]||(t[22]=y("p",null,"\u8BF7\u9009\u62E9\u8981\u5C06\u6587\u4EF6\u5BFC\u51FA\u5230\u7684\u9644\u4EF6\u5B57\u6BB5:",-1)),r(o(Be),{modelValue:U.value,"onUpdate:modelValue":t[3]||(t[3]=m=>U.value=m),placeholder:"\u9009\u62E9\u9644\u4EF6\u5B57\u6BB5",style:{width:"100%"}},{default:d(()=>[(x(!0),j(de,null,Fe(I.value,m=>(x(),X(o(De),{key:m.id,label:m.name,value:m.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),y("div",vu,[t[21]||(t[21]=y("p",null,"\u8BF7\u9009\u62E9\u5BFC\u51FA\u683C\u5F0F:",-1)),r(o(We),{modelValue:ne.value,"onUpdate:modelValue":t[4]||(t[4]=m=>ne.value=m)},{default:d(()=>[r(o(Ue),{label:"pdf"},{default:d(()=>t[19]||(t[19]=[h("PDF\u683C\u5F0F")])),_:1,__:[19]}),r(o(Ue),{label:"jpeg"},{default:d(()=>t[20]||(t[20]=[h("JPEG\u56FE\u7247\u683C\u5F0F")])),_:1,__:[20]})]),_:1},8,["modelValue"])]),t[23]||(t[23]=y("p",{class:"export-tip"},"\u6CE8\u610F: \u6BCF\u6761\u8BB0\u5F55\u5C06\u751F\u6210\u4E00\u4E2A\u5355\u72EC\u7684\u6587\u4EF6\uFF0C\u5E76\u4E0A\u4F20\u5230\u5BF9\u5E94\u8BB0\u5F55\u7684\u9644\u4EF6\u5B57\u6BB5\u4E2D",-1)),t[24]||(t[24]=y("p",{class:"export-tip"},"\u6CE8\u610F: JPEG\u683C\u5F0F\u4F1A\u4F7F\u7528\u6D4F\u89C8\u5668\u8FDB\u884C\u8F6C\u6362\uFF0C\u53EF\u80FD\u5F71\u54CD\u56FE\u7247\u8D28\u91CF\u548C\u7CFB\u7EDF\u6027\u80FD\uFF0C\u5EFA\u8BAE\u6839\u636E\u5B9E\u9645\u9700\u6C42\u9009\u62E9\u5408\u9002\u7684\u683C\u5F0F",-1))]))]),_:1},8,["modelValue"])])}}}),Eu=ye(wu,[["__scopeId","data-v-c4c1cf25"]]),Au={class:"field-info-viewer"},yu={class:"action-bar"},Cu={key:0},hu={key:1,class:"fields-container"},bu={key:0,class:"record-selector"},Su={__name:"FieldInfoViewer",setup(s){const F=E(""),c=E([]),D=E([]),v=E(""),w=E([]),f=E({});Ae(async()=>{await g(),await O()});async function g(){F.value="\u6B63\u5728\u83B7\u53D6\u5B57\u6BB5\u4FE1\u606F...",c.value=[],w.value=[],f.value={};try{const B=await q.base.getActiveTable(),S=await B.getActiveView(),_=B.id,b=S.id;c.value=await Je(_,b),F.value=`\u5DF2\u83B7\u53D6\u5F53\u524D\u89C6\u56FE\u4E0B ${c.value.length} \u4E2A\u53EF\u89C1\u5B57\u6BB5\u7684\u4FE1\u606F`}catch(B){F.value=`\u83B7\u53D6\u5B57\u6BB5\u4FE1\u606F\u65F6\u51FA\u9519: ${B.message}`,console.error("\u83B7\u53D6\u5B57\u6BB5\u4FE1\u606F\u65F6\u51FA\u9519:",B)}}async function O(){F.value="\u6B63\u5728\u83B7\u53D6\u6240\u6709\u8BB0\u5F55...",D.value=[];try{const B=await q.base.getActiveTable(),S=await B.getActiveView(),_=B.id,b=S.id,R=await Ee(_,b,null,!0);D.value=R,F.value=`\u5DF2\u83B7\u53D6 ${D.value.length} \u6761\u8BB0\u5F55`}catch(B){F.value=`\u83B7\u53D6\u8BB0\u5F55\u5217\u8868\u65F6\u51FA\u9519: ${B.message}`,console.error("\u83B7\u53D6\u8BB0\u5F55\u5217\u8868\u65F6\u51FA\u9519:",B)}}async function A(){if(!v.value){F.value="\u8BF7\u9009\u62E9\u8BB0\u5F55";return}F.value="\u6B63\u5728\u83B7\u53D6\u8BB0\u5F55\u503C...",w.value=[],f.value={};try{const B=await q.base.getActiveTable(),S=await B.getActiveView(),_=B.id,b=S.id,R=await Ee(_,b,v.value,!0);if(R.length>0){const V=R[0];w.value=V.field.map(k=>({fieldId:k.field,value:k.value})),f.value=V.field.reduce((k,N)=>(k[N.field]=N.value,k),{})}F.value=`\u5DF2\u83B7\u53D6\u8BB0\u5F55 ${v.value} \u7684\u6240\u6709\u5B57\u6BB5\u503C`}catch(B){F.value=`\u83B7\u53D6\u8BB0\u5F55\u503C\u65F6\u51FA\u9519: ${B.message}`,console.error("\u83B7\u53D6\u8BB0\u5F55\u503C\u65F6\u51FA\u9519:",B)}}return(B,S)=>{const _=P,b=De,R=Be,V=le,k=Oe;return x(),j("div",Au,[y("div",yu,[r(_,{type:"primary",onClick:g},{default:d(()=>S[1]||(S[1]=[h("\u83B7\u53D6\u5B57\u6BB5\u4FE1\u606F")])),_:1,__:[1]}),r(_,{type:"success",onClick:A,disabled:!v.value||c.value.length===0},{default:d(()=>S[2]||(S[2]=[h(" \u83B7\u53D6\u8BB0\u5F55\u503C ")])),_:1,__:[2]},8,["disabled"])]),F.value?(x(),j("div",Cu,H(F.value),1)):Z("",!0),c.value.length>0?(x(),j("div",hu,[y("h3",null,"\u5B57\u6BB5\u6570\u91CF: "+H(c.value.length),1),D.value.length>0?(x(),j("div",bu,[r(R,{modelValue:v.value,"onUpdate:modelValue":S[0]||(S[0]=N=>v.value=N),placeholder:"\u8BF7\u9009\u62E9\u8BB0\u5F55",style:{width:"300px","margin-bottom":"20px"},filterable:"",onChange:A},{default:d(()=>[(x(!0),j(de,null,Fe(D.value,N=>{var M;return x(),X(b,{key:N.recordId,label:((M=N.field[0])==null?void 0:M.value)||N.recordId,value:N.recordId},null,8,["label","value"])}),128))]),_:1},8,["modelValue"])])):Z("",!0),r(k,{data:c.value,style:{width:"100%"}},{default:d(()=>[r(V,{prop:"id",label:"\u5B57\u6BB5ID",width:"280"}),r(V,{prop:"name",label:"\u5B57\u6BB5\u540D\u79F0",width:"180"}),r(V,{prop:"type",label:"\u5B57\u6BB5\u7C7B\u578B"}),w.value.length>0?(x(),X(V,{key:0,label:"\u5B57\u6BB5\u503C"},{default:d(N=>[y("pre",null,H(f.value[N.row.id]),1)]),_:1})):Z("",!0)]),_:1},8,["data"])])):Z("",!0)])}}},_u=ye(Su,[["__scopeId","data-v-069590c1"]]),Tu="hiprintDB",ue="templates",xu=1;function Re(){return new Promise((s,F)=>{const c=window.indexedDB.open(Tu,xu);c.onerror=D=>F(D.target.error),c.onsuccess=D=>s(D.target.result),c.onupgradeneeded=D=>{const v=D.target.result;v.objectStoreNames.contains(ue)||v.createObjectStore(ue,{keyPath:"id"}).createIndex("description","description",{unique:!1})}})}async function ve(s,F,c=""){const D=await Re();return new Promise((v,w)=>{try{const f=JSON.parse(JSON.stringify(F)),g=D.transaction(ue,"readwrite");g.objectStore(ue).put({id:s,data:f,description:c,createdAt:new Date().toISOString()}),g.oncomplete=()=>v(),g.onerror=A=>w(A.target.error)}catch(f){w(f)}})}async function ke(){const s=await Re();return new Promise((F,c)=>{const w=s.transaction(ue,"readonly").objectStore(ue).getAll();w.onsuccess=()=>F(w.result||[]),w.onerror=f=>c(f.target.error)})}async function qe(s){const F=await Re();return new Promise((c,D)=>{const v=F.transaction(ue,"readwrite");v.objectStore(ue).delete(s),v.oncomplete=()=>c(),v.onerror=f=>D(f.target.error)})}const Pu={class:"template-manager"},Vu={class:"template-manager-header"},Iu={class:"template-manager-actions"},ku={class:"dialog-footer"},$u=$e({__name:"TemplateManager",props:{hiprintTemplate:Object},emits:["load-template"],setup(s,{emit:F}){const c=s,D=F,v=E([]),w=E(!1),f=E(""),g=E(!1),O=E("\u65B0\u589E\u6A21\u677F"),A=E(!1),B=E({id:"",name:"",description:"",data:null});E(!1),E("");async function S(){try{w.value=!0;const p=await ke();v.value=p}catch(p){console.error("\u52A0\u8F7D\u6A21\u677F\u5217\u8868\u5931\u8D25:",p),n.error("\u52A0\u8F7D\u6A21\u677F\u5217\u8868\u5931\u8D25: "+(p.message||String(p)))}finally{w.value=!1}}function _(){A.value=!1,O.value="\u65B0\u589E\u6A21\u677F",B.value={id:"",name:"",description:"",data:c.hiprintTemplate?c.hiprintTemplate.getJson():null},g.value=!0}function b(p){A.value=!0,O.value="\u7F16\u8F91\u6A21\u677F",B.value={id:p.id,name:p.id,description:p.description||"",data:p.data},g.value=!0}async function R(){try{if(!B.value.name){n.warning("\u8BF7\u8F93\u5165\u6A21\u677F\u540D\u79F0");return}A.value&&B.value.id!==B.value.name&&await qe(B.value.id);const p=JSON.parse(JSON.stringify(B.value.data));await ve(B.value.name,p,B.value.description||B.value.name),n.success("\u6A21\u677F\u4FDD\u5B58\u6210\u529F"),g.value=!1,await S()}catch(p){console.error("\u4FDD\u5B58\u6A21\u677F\u5931\u8D25:",p),n.error("\u4FDD\u5B58\u6A21\u677F\u5931\u8D25: "+(p.message||String(p)))}}async function V(p){try{await Ve.confirm("\u786E\u5B9A\u8981\u5220\u9664\u8FD9\u4E2A\u6A21\u677F\u5417\uFF1F","\u63D0\u793A",{confirmButtonText:"\u786E\u5B9A",cancelButtonText:"\u53D6\u6D88",type:"warning"}),await qe(p),n.success("\u6A21\u677F\u5DF2\u5220\u9664"),await S()}catch(i){i!=="cancel"&&(console.error("\u5220\u9664\u6A21\u677F\u5931\u8D25:",i),n.error("\u5220\u9664\u6A21\u677F\u5931\u8D25: "+(i.message||String(i))))}}function k(p){D("load-template",p.data),n.success("\u6A21\u677F\u5DF2\u52A0\u8F7D\u5230\u8BBE\u8BA1\u5668")}function N(p){try{const i=JSON.stringify(p.data,null,2),$=new Blob([i],{type:"application/json"}),C=URL.createObjectURL($),I=document.createElement("a");I.href=C,I.download=`${p.id}_${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(I),I.click(),document.body.removeChild(I),URL.revokeObjectURL(C),n.success("\u6A21\u677F\u5BFC\u51FA\u6210\u529F")}catch(i){console.error("\u5BFC\u51FA\u6A21\u677F\u5931\u8D25:",i),n.error("\u5BFC\u51FA\u6A21\u677F\u5931\u8D25: "+(i.message||String(i)))}}function M(){try{if(v.value.length===0){n.warning("\u6CA1\u6709\u53EF\u5BFC\u51FA\u7684\u6A21\u677F");return}const p={};v.value.forEach(U=>{p[U.id]=U.data});const i=JSON.stringify(p,null,2),$=new Blob([i],{type:"application/json"}),C=URL.createObjectURL($),I=document.createElement("a");I.href=C,I.download=`\u6240\u6709\u6A21\u677F_${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(I),I.click(),document.body.removeChild(I),URL.revokeObjectURL(C),n.success(`\u5DF2\u5BFC\u51FA ${v.value.length} \u4E2A\u6A21\u677F`)}catch(p){console.error("\u5BFC\u51FA\u6240\u6709\u6A21\u677F\u5931\u8D25:",p),n.error("\u5BFC\u51FA\u6240\u6709\u6A21\u677F\u5931\u8D25: "+(p.message||String(p)))}}function G(){const p=document.createElement("input");p.type="file",p.accept="application/json",p.style.display="none",document.body.appendChild(p),p.addEventListener("change",async i=>{const $=i.target.files[0];if(!$){document.body.removeChild(p);return}try{const C=await K($);await J(C)}catch(C){console.error("\u5BFC\u5165\u6A21\u677F\u5931\u8D25:",C),n.error("\u5BFC\u5165\u6A21\u677F\u5931\u8D25: "+(C.message||String(C)))}finally{document.body.removeChild(p)}}),p.click()}function K(p){return new Promise((i,$)=>{const C=new FileReader;C.onload=I=>{try{const U=JSON.parse(I.target.result);i(U)}catch{$(new Error("\u65E0\u6548\u7684JSON\u6587\u4EF6"))}},C.onerror=()=>$(new Error("\u8BFB\u53D6\u6587\u4EF6\u5931\u8D25")),C.readAsText(p)})}async function J(p){try{if(typeof p=="object"&&!Array.isArray(p))if(p.panels!==void 0||p.width!==void 0)await Ve.prompt("\u8BF7\u8F93\u5165\u6A21\u677F\u540D\u79F0","\u5BFC\u5165\u6A21\u677F",{confirmButtonText:"\u786E\u8BA4",cancelButtonText:"\u53D6\u6D88",inputPattern:/.+/,inputErrorMessage:"\u6A21\u677F\u540D\u79F0\u4E0D\u80FD\u4E3A\u7A7A"}).then(async({value:i})=>{const $=JSON.parse(JSON.stringify(p));await ve(i,$,i),n.success("\u6A21\u677F\u5BFC\u5165\u6210\u529F")});else{let i=0;for(const[$,C]of Object.entries(p)){const I=JSON.parse(JSON.stringify(C));await ve($,I,$),i++}n.success(`\u6210\u529F\u5BFC\u5165 ${i} \u4E2A\u6A21\u677F`)}else{n.error("\u65E0\u6548\u7684\u6A21\u677F\u6570\u636E\u683C\u5F0F");return}await S()}catch(i){i!=="cancel"&&(console.error("\u5BFC\u5165\u6A21\u677F\u5931\u8D25:",i),n.error("\u5BFC\u5165\u6A21\u677F\u5931\u8D25: "+(i.message||String(i))))}}function Q(){if(!f.value)return v.value;const p=f.value.toLowerCase();return v.value.filter(i=>i.id.toLowerCase().includes(p))}return Ae(()=>{S()}),(p,i)=>{const $=Xe;return x(),j("div",Pu,[r(o(Ye),{title:"\u63D0\u793A\uFF1A\u6A21\u677F\u4FDD\u5B58\u5728\u6D4F\u89C8\u5668\u7F13\u5B58\u4E2D\uFF0C\u8BF7\u53CA\u65F6\u5BFC\u51FA\u5907\u4EFD\uFF0C\u907F\u514D\u6570\u636E\u4E22\u5931",type:"warning",closable:!1,"show-icon":"",style:{"margin-bottom":"20px"}}),y("div",Vu,[i[9]||(i[9]=y("h2",null,"\u6A21\u677F\u7BA1\u7406",-1)),y("div",Iu,[r(o(re),{modelValue:f.value,"onUpdate:modelValue":i[0]||(i[0]=C=>f.value=C),placeholder:"\u641C\u7D22\u6A21\u677F",clearable:"",style:{width:"200px","margin-right":"10px"}},null,8,["modelValue"]),r(o(P),{type:"primary",onClick:_},{default:d(()=>i[5]||(i[5]=[h("\u4FDD\u5B58\u5F53\u524D\u6A21\u677F")])),_:1,__:[5]}),r(o(P),{type:"success",onClick:M},{default:d(()=>i[6]||(i[6]=[h("\u5BFC\u51FA\u6240\u6709\u6A21\u677F")])),_:1,__:[6]}),r(o(P),{type:"info",onClick:G},{default:d(()=>i[7]||(i[7]=[h("\u5BFC\u5165\u6A21\u677F")])),_:1,__:[7]}),r(o(P),{onClick:S},{default:d(()=>i[8]||(i[8]=[h("\u5237\u65B0\u5217\u8868")])),_:1,__:[8]})])]),Pe((x(),X(o(Oe),{data:Q(),style:{width:"100%"},border:""},{default:d(()=>[r(o(le),{prop:"id",label:"\u6A21\u677F\u540D\u79F0","min-width":"150"}),r(o(le),{prop:"description",label:"\u6A21\u677F\u63CF\u8FF0","min-width":"150"}),r(o(le),{label:"\u521B\u5EFA/\u4FEE\u6539\u65F6\u95F4","min-width":"180"},{default:d(C=>[h(H(C.row.createdAt?new Date(C.row.createdAt).toLocaleString():new Date().toLocaleString()),1)]),_:1}),r(o(le),{label:"\u64CD\u4F5C",width:"280"},{default:d(({row:C})=>[r(o(P),{type:"primary",size:"small",onClick:I=>k(C)},{default:d(()=>i[10]||(i[10]=[h(" \u52A0\u8F7D\u5230\u8BBE\u8BA1\u5668 ")])),_:2,__:[10]},1032,["onClick"]),r(o(P),{type:"success",size:"small",onClick:I=>N(C)},{default:d(()=>i[11]||(i[11]=[h(" \u5BFC\u51FA ")])),_:2,__:[11]},1032,["onClick"]),r(o(P),{type:"warning",size:"small",onClick:I=>b(C)},{default:d(()=>i[12]||(i[12]=[h(" \u7F16\u8F91 ")])),_:2,__:[12]},1032,["onClick"]),r(o(P),{type:"danger",size:"small",onClick:I=>V(C.id)},{default:d(()=>i[13]||(i[13]=[h(" \u5220\u9664 ")])),_:2,__:[13]},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[$,w.value]]),r(o(Ne),{modelValue:g.value,"onUpdate:modelValue":i[4]||(i[4]=C=>g.value=C),title:O.value,width:"500px"},{footer:d(()=>[y("span",ku,[r(o(P),{onClick:i[3]||(i[3]=C=>g.value=!1)},{default:d(()=>i[14]||(i[14]=[h("\u53D6\u6D88")])),_:1,__:[14]}),r(o(P),{type:"primary",onClick:R},{default:d(()=>i[15]||(i[15]=[h("\u786E\u8BA4")])),_:1,__:[15]})])]),default:d(()=>[r(o(Ge),{model:B.value,"label-width":"100px"},{default:d(()=>[r(o(we),{label:"\u6A21\u677F\u540D\u79F0"},{default:d(()=>[r(o(re),{modelValue:B.value.name,"onUpdate:modelValue":i[1]||(i[1]=C=>B.value.name=C),placeholder:"\u8BF7\u8F93\u5165\u6A21\u677F\u540D\u79F0"},null,8,["modelValue"])]),_:1}),r(o(we),{label:"\u6A21\u677F\u63CF\u8FF0"},{default:d(()=>[r(o(re),{modelValue:B.value.description,"onUpdate:modelValue":i[2]||(i[2]=C=>B.value.description=C),type:"textarea",placeholder:"\u8BF7\u8F93\u5165\u6A21\u677F\u63CF\u8FF0"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}}),Ou=ye($u,[["__scopeId","data-v-a933827a"]]),Nu={class:"hiprint-viewer"},Ju={key:0,class:"message"},Ru={key:1,class:"records-loading-message"},Lu={key:2,class:"loading-overlay"},ju={class:"hiprint-container"},Uu={class:"tabs-header"},zu={class:"tab-content"},Mu={key:0,class:"design-container"},Hu={class:"template-wrapper"},qu={class:"template-actions"},Gu={class:"action-group"},Ku={class:"action-group"},Wu={class:"hiprint-printPagination"},Qu={class:"dialog-footer"},Xu=$e({__name:"hiprintViewer",setup(s){const F=Ze(),c=E(""),D=E([]),v=E([]),w=E("design");let f=null,g=E(!0);const O=E(!1),A=E(""),B=E([{label:"A4",value:"A4",width:210,height:297},{label:"A5",value:"A5",width:148,height:210},{label:"B5",value:"B5",width:176,height:250},{label:"\u81EA\u5B9A\u4E49",value:"custom",width:100,height:150}]),S=E("A4"),_=E(!1),b=E({width:100,height:150}),R=E([]),V=E(""),k=E("");Ae(async()=>{try{g.value=!0,c.value="\u6B63\u5728\u521D\u59CB\u5316...",window.addEventListener("message",he),c.value="\u6B63\u5728\u52A0\u8F7D\u5B57\u6BB5\u4FE1\u606F...",await N(),c.value="\u6B63\u5728\u521D\u59CB\u5316\u6253\u5370\u7EC4\u4EF6...",await G(),await Ce()||(c.value="\u6B63\u5728\u52A0\u8F7D\u9ED8\u8BA4\u6A21\u677F...",await a()),await pe(),g.value=!1,c.value="",M()}catch(e){console.error("\u521D\u59CB\u5316\u5931\u8D25:",e),c.value="\u521D\u59CB\u5316\u5931\u8D25: "+(e.message||String(e)),g.value=!1}});async function N(){try{const e=await q.base.getActiveTable(),u=await e.getActiveView(),l=e.id,m=u.id;return D.value=await Je(l,m),{fields:D.value,tableId:l,viewId:m}}catch(e){throw console.error("\u83B7\u53D6\u5B57\u6BB5\u5931\u8D25:",e),e}}async function M(){try{O.value=!0,A.value="\u6B63\u5728\u52A0\u8F7D\u8BB0\u5F55\u6570\u636E\uFF0C\u8FD9\u53EF\u80FD\u9700\u8981\u4E00\u4E9B\u65F6\u95F4...";const e=await q.base.getActiveTable(),u=await e.getActiveView(),l=e.id,m=u.id;await Ee(l,m,null,!0,(T,L,me)=>{if(v.value=T.map(z=>{const W={recordId:z.recordId,field:z.field};return z.field&&z.field.forEach(fe=>{W[fe.field]=fe.value}),W}),T.length>0){const z=T[0];window.fieldTestData={},z&&z.field&&z.field.forEach(W=>{window.fieldTestData[W.field]=W.value})}me?(A.value=`\u5DF2\u6210\u529F\u52A0\u8F7D ${T.length} \u6761\u8BB0\u5F55`,setTimeout(()=>{A.value=""},3e3)):A.value=`\u5DF2\u52A0\u8F7D ${T.length} \u6761\u8BB0\u5F55\uFF0C\u6B63\u5728\u7EE7\u7EED\u52A0\u8F7D...\uFF08\u6279\u6B21 ${L}\uFF09`})}catch(e){console.error("\u83B7\u53D6\u8BB0\u5F55\u5931\u8D25:",e),A.value="\u83B7\u53D6\u8BB0\u5F55\u5931\u8D25: "+(e.message||String(e)),setTimeout(()=>{A.value=""},5e3)}finally{O.value=!1}}async function G(){try{ae("#provider-container").empty(),ae("#hiprint-printTemplate").empty(),se.exports.hiprint.init({providers:[se.exports.defaultElementTypeProvider(),au(D.value,window.fieldTestData)()]}),se.exports.hiprint.PrintElementTypeManager.build(ae("#provider-container"),"defaultModule"),se.exports.hiprint.PrintElementTypeManager.build(ae("#provider-container"),"customModule"),f=new se.exports.hiprint.PrintTemplate({template:{},settingContainer:"#PrintElementOptionSetting",paginationContainer:".hiprint-printPagination",fontList:[{title:"\u5FAE\u8F6F\u96C5\u9ED1",value:"Microsoft YaHei"},{title:"\u9ED1\u4F53",value:"STHeitiSC-Light"},{title:"\u601D\u6E90\u9ED1\u4F53",value:"SourceHanSansCN-Normal"},{title:"\u5B8B\u4F53",value:"SimSun"},{title:"\u534E\u4E3A\u6977\u4F53",value:"STKaiti"}],dataMode:1,history:!0,onDataChanged:(e,u)=>{console.log("\u6A21\u677F\u53D8\u66F4\u7C7B\u578B:",e),console.log("\u6A21\u677F\u6570\u636E:",u)},onUpdateError:e=>{console.error("\u66F4\u65B0\u5931\u8D25:",e)}}),f.design("#hiprint-printTemplate",{grid:!0}),setTimeout(()=>{ae(".ep-draggable-item-group").each(function(){const e=ae(this).children(".ep-draggable-item");e.length>0&&e.wrapAll('<div class="ep-draggable-item-list"></div>')})},500)}catch(e){throw console.error("\u521D\u59CB\u5316\u6253\u5370\u7EC4\u4EF6\u5931\u8D25:",e),c.value="\u521D\u59CB\u5316\u6253\u5370\u7EC4\u4EF6\u5931\u8D25: "+(e.message||String(e)),e}}function K(){const e=f.getJson();return console.log("\u6A21\u677FJSON:",e),e}function J(e){try{ae("#hiprint-printTemplate").empty(),f.update(e),f.design("#hiprint-printTemplate",{grid:!0}),n.success("\u6A21\u677F\u5BFC\u5165\u6210\u529F")}catch(u){console.error("\u5BFC\u5165\u6A21\u677F\u5931\u8D25:",u),n.error("\u5BFC\u5165\u6A21\u677F\u5931\u8D25: "+(u.message||String(u)))}}function Q(e){try{const u=B.value.find(l=>l.value===e);if(!u)return;f.setPaper(e),n.success(`\u5DF2\u8BBE\u7F6E\u7EB8\u5F20\u5927\u5C0F: ${u.label}`)}catch(u){console.error("\u8BBE\u7F6E\u7EB8\u5F20\u5927\u5C0F\u5931\u8D25:",u),n.error("\u8BBE\u7F6E\u7EB8\u5F20\u5927\u5C0F\u5931\u8D25: "+(u.message||String(u)))}}function p(){try{const e=parseFloat(b.value.width.toString()),u=parseFloat(b.value.height.toString());if(isNaN(e)||e<=0||isNaN(u)||u<=0){n.error("\u8BF7\u8F93\u5165\u6709\u6548\u7684\u7EB8\u5F20\u5C3A\u5BF8");return}f.setPaper(e,u),n.success(`\u5DF2\u8BBE\u7F6E\u81EA\u5B9A\u4E49\u7EB8\u5F20\u5927\u5C0F: ${e}mm x ${u}mm`),_.value=!1}catch(e){console.error("\u8BBE\u7F6E\u81EA\u5B9A\u4E49\u7EB8\u5F20\u5931\u8D25:",e),n.error("\u8BBE\u7F6E\u81EA\u5B9A\u4E49\u7EB8\u5F20\u5931\u8D25: "+(e.message||String(e)))}}function i(e){S.value=e,e==="custom"?(b.value={width:100,height:150},_.value=!0):Q(e)}function $(e){switch(e){case"export":oe();break;case"import":C();break;case"paste":I();break}}function C(){const e=document.createElement("input");e.type="file",e.accept="application/json",e.style.display="none",document.body.appendChild(e),e.addEventListener("change",u=>{const l=u.target.files[0];if(!l){document.body.removeChild(e);return}const m=new FileReader;m.onload=T=>{try{const L=JSON.parse(T.target.result);J(L),n.success("\u6A21\u677F\u5BFC\u5165\u6210\u529F")}catch(L){console.error("\u89E3\u6790JSON\u5931\u8D25:",L),n.error("\u65E0\u6548\u7684\u6A21\u677F\u6587\u4EF6")}},m.onerror=()=>{n.error("\u8BFB\u53D6\u6587\u4EF6\u5931\u8D25")},m.readAsText(l),document.body.removeChild(e)}),e.click()}function I(){Ve.prompt("\u8BF7\u7C98\u8D34\u6A21\u677FJSON\u6570\u636E","\u5BFC\u5165\u6A21\u677F",{confirmButtonText:"\u5BFC\u5165",cancelButtonText:"\u53D6\u6D88",inputType:"textarea",inputPlaceholder:"\u7C98\u8D34JSON\u6570\u636E..."}).then(({value:e})=>{try{if(!e){n.warning("\u672A\u63D0\u4F9BJSON\u6570\u636E");return}const u=JSON.parse(e);J(u),n.success("\u6A21\u677F\u5BFC\u5165\u6210\u529F")}catch(u){console.error("\u5BFC\u5165JSON\u5931\u8D25:",u),n.error("\u65E0\u6548\u7684JSON\u6570\u636E: "+(u.message||String(u)))}}).catch(()=>{})}function U(e){f.print(e)}function ee(e,u){f.toPdf(e,u)}function oe(){try{const e=K(),u=JSON.stringify(e,null,2),l=new Blob([u],{type:"application/json"}),m=URL.createObjectURL(l),T=document.createElement("a");T.href=m,T.download=`\u6253\u5370\u6A21\u677F_${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(T),T.click(),document.body.removeChild(T),URL.revokeObjectURL(m),n.success("\u6A21\u677F\u5BFC\u51FA\u6210\u529F")}catch(e){console.error("\u5BFC\u51FA\u6A21\u677F\u5931\u8D25:",e),n.error("\u5BFC\u51FA\u6A21\u677F\u5931\u8D25")}}function ie(){try{const e=D.value.length>0?{fields:D.value}:{};U(e),n.success("\u6253\u5370\u9884\u89C8\u5DF2\u751F\u6210")}catch(e){console.error("\u6253\u5370\u9884\u89C8\u5931\u8D25:",e),n.error("\u6253\u5370\u9884\u89C8\u5931\u8D25")}}function te(){try{const e=`\u6253\u5370\u6A21\u677F_${new Date().toISOString().split("T")[0]}.pdf`,u=D.value.length>0?{fields:D.value}:{};ee(u,e),n.success("PDF\u5BFC\u51FA\u6210\u529F")}catch(e){console.error("\u5BFC\u51FAPDF\u5931\u8D25:",e),n.error("\u5BFC\u51FAPDF\u5931\u8D25")}}function Y(e,u=!1){try{if(!e||Array.isArray(e)&&e.length===0){n.warning("\u6CA1\u6709\u53EF\u6253\u5370\u7684\u6570\u636E");return}if(u){const l=`\u6253\u5370\u6570\u636E_${new Date().toISOString().split("T")[0]}.pdf`;ee(e,l),n.success("PDF\u5BFC\u51FA\u6210\u529F")}else U(e),n.success("\u6253\u5370\u9884\u89C8\u5DF2\u751F\u6210");console.log("\u6253\u5370\u6570\u636E\u7ED3\u6784:",JSON.stringify(e))}catch(l){console.error("\u6253\u5370\u5904\u7406\u5931\u8D25:",l),n.error("\u6253\u5370\u5904\u7406\u5931\u8D25: "+(l.message||String(l)))}}function ne(){try{const e=f?f.getJson():{},u=JSON.parse(JSON.stringify(D.value||[])).map(L=>({id:L.id,name:L.name,type:L.type,displayName:L.displayName||L.name})),l=JSON.parse(JSON.stringify(window.fieldTestData||{})),m={template:e,fields:u,testData:l},T=JSON.stringify(m);try{const L=btoa(encodeURIComponent(T)),z=window.location.origin+window.location.pathname+"#/template-designer?data="+L;if(z.length>2e3)throw new Error("URL too long");const W=window.open(z,"_blank","width=1200,height=800");if(!W||W.closed||typeof W.closed>"u"){n.error("\u5F39\u7A97\u88AB\u6D4F\u89C8\u5668\u963B\u6B62\uFF0C\u8BF7\u5141\u8BB8\u5F39\u7A97\u540E\u91CD\u8BD5");return}n.success("\u6B63\u5728\u6253\u5F00\u6A21\u677F\u8BBE\u8BA1\u5668")}catch(L){console.warn("URL\u6570\u636E\u8FC7\u5927\uFF0C\u5C1D\u8BD5\u7B80\u5316\u6570\u636E:",L);const me={template:e,fields:u.map(Te=>({id:Te.id,name:Te.name,type:Te.type}))},z=JSON.stringify(me),W=btoa(encodeURIComponent(z)),fe=window.location.origin+window.location.pathname+"#/template-designer?data="+W,_e=window.open(fe,"_blank","width=1200,height=800");if(!_e||_e.closed||typeof _e.closed>"u"){n.error("\u5F39\u7A97\u88AB\u6D4F\u89C8\u5668\u963B\u6B62\uFF0C\u8BF7\u5141\u8BB8\u5F39\u7A97\u540E\u91CD\u8BD5");return}n.success("\u6B63\u5728\u6253\u5F00\u6A21\u677F\u8BBE\u8BA1\u5668\uFF08\u6570\u636E\u5DF2\u7B80\u5316\uFF09")}}catch(e){console.error("\u6253\u5F00\u6A21\u677F\u8BBE\u8BA1\u5668\u5931\u8D25:",e),n.error("\u6253\u5F00\u6A21\u677F\u8BBE\u8BA1\u5668\u5931\u8D25: "+(e.message||String(e)))}}async function Ce(){return new Promise(e=>{try{const u=localStorage.getItem("templateDesignerData");if(!u){console.log("\u6CA1\u6709\u627E\u5230\u4FDD\u5B58\u7684\u6A21\u677F\u6570\u636E"),e(!1);return}try{const l=JSON.parse(u);console.log("\u53D1\u73B0\u4FDD\u5B58\u7684\u6A21\u677F\u6570\u636E"),l&&l.template?(console.log("\u6B63\u5728\u5BFC\u5165\u6A21\u677F..."),J(l.template),localStorage.removeItem("templateDesignerData"),console.log("\u5DF2\u5220\u9664\u4FDD\u5B58\u7684\u6A21\u677F\u6570\u636E"),n.success("\u5DF2\u6210\u529F\u5BFC\u5165\u6A21\u677F\u8BBE\u8BA1\u5668\u4E2D\u4FDD\u5B58\u7684\u6A21\u677F"),e(!0)):(console.warn("\u4FDD\u5B58\u7684\u6A21\u677F\u6570\u636E\u4E0D\u5B8C\u6574"),e(!1))}catch(l){console.error("\u89E3\u6790\u4FDD\u5B58\u7684\u6A21\u677F\u6570\u636E\u5931\u8D25:",l),n.error("\u89E3\u6790\u4FDD\u5B58\u7684\u6A21\u677F\u6570\u636E\u5931\u8D25: "+(l.message||String(l))),e(!1)}}catch(u){console.error("\u68C0\u67E5\u4FDD\u5B58\u7684\u6A21\u677F\u5931\u8D25:",u),e(!1)}})}function he(e){try{e.data&&e.data.type==="TEMPLATE_SAVED"&&(console.log("\u6536\u5230\u6A21\u677F\u8BBE\u8BA1\u9875\u9762\u53D1\u9001\u7684\u6A21\u677F\u6570\u636E"),e.data.template?(J(e.data.template),n.success("\u5DF2\u6210\u529F\u5BFC\u5165\u6A21\u677F\u8BBE\u8BA1\u5668\u4E2D\u4FDD\u5B58\u7684\u6A21\u677F")):(console.warn("\u6536\u5230\u7684\u6A21\u677F\u6570\u636E\u4E0D\u5B8C\u6574"),n.warning("\u6536\u5230\u7684\u6A21\u677F\u6570\u636E\u4E0D\u5B8C\u6574")))}catch(u){console.error("\u5904\u7406\u6A21\u677F\u8BBE\u8BA1\u9875\u9762\u6D88\u606F\u5931\u8D25:",u),n.error("\u5904\u7406\u6A21\u677F\u8BBE\u8BA1\u9875\u9762\u6D88\u606F\u5931\u8D25: "+(u.message||String(u)))}}async function be(){try{if(!k.value){n.warning("\u8BF7\u8F93\u5165\u6A21\u677F\u540D\u79F0");return}const e=f.getJson(),u=JSON.parse(JSON.stringify(e));await ve(k.value,u,k.value),n.success("\u6A21\u677F\u5DF2\u4FDD\u5B58\u5230\u672C\u5730\u6570\u636E\u5E93"),await pe()}catch(e){console.error("\u4FDD\u5B58\u6A21\u677F\u5931\u8D25:",e),n.error("\u4FDD\u5B58\u6A21\u677F\u5931\u8D25: "+(e.message||String(e)))}}async function pe(){try{const e=await ke();R.value=e}catch(e){console.error("\u52A0\u8F7D\u6A21\u677F\u5217\u8868\u5931\u8D25:",e),n.error("\u52A0\u8F7D\u6A21\u677F\u5217\u8868\u5931\u8D25: "+(e.message||String(e)))}}function Se(e){try{if(!e){n.warning("\u6A21\u677F\u6570\u636E\u4E3A\u7A7A");return}w.value="design",J(e),n.success("\u6A21\u677F\u5DF2\u6210\u529F\u52A0\u8F7D\u5230\u8BBE\u8BA1\u5668")}catch(u){console.error("\u52A0\u8F7D\u6A21\u677F\u5931\u8D25:",u),n.error("\u52A0\u8F7D\u6A21\u677F\u5931\u8D25: "+(u.message||String(u)))}}async function a(){try{const e=f.getJson();if(e&&Object.keys(e).length>0&&(e.printElements||[]).length>0){console.log("\u5DF2\u6709\u6A21\u677F\u6570\u636E\uFF0C\u4E0D\u9700\u8981\u52A0\u8F7D\u9ED8\u8BA4\u6A21\u677F");return}const l=await ke();if(l&&l.length>0){const T=l[0];console.log(`\u4ECE\u6570\u636E\u5E93\u52A0\u8F7D\u6A21\u677F: ${T.id}`),J(T.data),V.value=T.id,k.value=T.description||T.id,n.success(`\u5DF2\u81EA\u52A8\u52A0\u8F7D\u6A21\u677F: ${T.id}`);return}console.log("\u6570\u636E\u5E93\u4E2D\u6CA1\u6709\u6A21\u677F\uFF0C\u4F7F\u7528\u9ED8\u8BA4\u7A7A\u767D\u6A21\u677F");const m={width:210,height:297,paperHeader:0,paperFooter:0,printElements:[]};f.clear(),f.setPaper("A4"),f.design("#hiprint-printTemplate",{grid:!0})}catch(e){console.error("\u52A0\u8F7D\u9ED8\u8BA4\u6A21\u677F\u5931\u8D25:",e)}}function t(){F.push("/help")}return(e,u)=>(x(),j("div",Nu,[c.value?(x(),j("div",Ju,H(c.value),1)):Z("",!0),A.value?(x(),j("div",Ru,H(A.value),1)):Z("",!0),o(g)?(x(),j("div",Lu,u[7]||(u[7]=[y("div",{class:"loading-spinner"},null,-1),y("div",{class:"loading-text"},"\u52A0\u8F7D\u4E2D...",-1)]))):Z("",!0),Pe(y("div",ju,[y("div",Uu,[r(o(eu),{modelValue:w.value,"onUpdate:modelValue":u[0]||(u[0]=l=>w.value=l),class:"hiprint-tabs"},{default:d(()=>[r(o(ge),{label:"\u8BBE\u8BA1\u6A21\u677F",name:"design"}),r(o(ge),{label:"\u6570\u636E\u6253\u5370",name:"print"}),r(o(ge),{label:"\u6A21\u677F\u7BA1\u7406",name:"template-manager"}),r(o(ge),{label:"\u5B57\u6BB5\u4FE1\u606F",name:"field-info"})]),_:1},8,["modelValue"]),r(o(P),{type:"primary",onClick:t,size:"small"},{default:d(()=>u[8]||(u[8]=[h("\u4F7F\u7528\u5E2E\u52A9")])),_:1,__:[8]})]),y("div",zu,[w.value==="design"?(x(),j("div",Mu,[u[17]||(u[17]=y("div",{id:"provider-container",class:"provider-container"},null,-1)),y("div",Hu,[y("div",qu,[y("div",Gu,[r(o(re),{modelValue:k.value,"onUpdate:modelValue":u[1]||(u[1]=l=>k.value=l),placeholder:"\u8F93\u5165\u6A21\u677F\u540D\u79F0",style:{width:"150px","margin-right":"10px"}},null,8,["modelValue"]),r(o(P),{type:"primary",size:"small",onClick:be},{default:d(()=>u[9]||(u[9]=[h("\u4FDD\u5B58\u6A21\u677F")])),_:1,__:[9]}),r(o(tu),{onCommand:$,trigger:"click"},{dropdown:d(()=>[r(o(uu),null,{default:d(()=>[r(o(Me),{command:"export"},{default:d(()=>u[11]||(u[11]=[h("\u5BFC\u51FAJSON")])),_:1,__:[11]}),r(o(Me),{command:"import"},{default:d(()=>u[12]||(u[12]=[h("\u5BFC\u5165\u6A21\u677F")])),_:1,__:[12]})]),_:1})]),default:d(()=>[r(o(P),{type:"primary",size:"small"},{default:d(()=>u[10]||(u[10]=[h(" \u6A21\u677F\u64CD\u4F5C"),y("i",{class:"el-icon-arrow-down el-icon--right"},null,-1)])),_:1,__:[10]})]),_:1})]),y("div",Ku,[r(o(Be),{modelValue:S.value,"onUpdate:modelValue":u[2]||(u[2]=l=>S.value=l),placeholder:"\u9009\u62E9\u7EB8\u5F20\u5927\u5C0F",size:"small",onChange:i,style:{width:"120px","margin-right":"10px"}},{default:d(()=>[(x(!0),j(de,null,Fe(B.value,l=>(x(),X(o(De),{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),r(o(P),{type:"success",size:"small",onClick:ne},{default:d(()=>u[13]||(u[13]=[h("\u72EC\u7ACB\u8BBE\u8BA1\u5668(\u63A8\u8350\u4F7F\u7528)")])),_:1,__:[13]}),r(o(P),{type:"success",size:"small",onClick:ie},{default:d(()=>u[14]||(u[14]=[h("\u6253\u5370\u9884\u89C8")])),_:1,__:[14]}),r(o(P),{type:"warning",size:"small",onClick:te},{default:d(()=>u[15]||(u[15]=[h("\u5BFC\u51FAPDF")])),_:1,__:[15]})])]),u[16]||(u[16]=y("div",{id:"hiprint-printTemplate",class:"template-container"},null,-1))]),u[18]||(u[18]=y("div",{id:"PrintElementOptionSetting",class:"setting-container"},null,-1))])):w.value==="print"?(x(),X(Eu,{key:1,hiprintTemplate:o(f),initialFields:D.value,initialRecords:v.value,onPrint:Y},null,8,["hiprintTemplate","initialFields","initialRecords"])):w.value==="template-manager"?(x(),X(Ou,{key:2,hiprintTemplate:o(f),onLoadTemplate:Se},null,8,["hiprintTemplate"])):w.value==="field-info"?(x(),X(_u,{key:3})):Z("",!0)])],512),[[ze,!o(g)]]),Pe(y("div",Wu,null,512),[[ze,!o(g)&&w.value==="design"]]),r(o(Ne),{modelValue:_.value,"onUpdate:modelValue":u[6]||(u[6]=l=>_.value=l),title:"\u81EA\u5B9A\u4E49\u7EB8\u5F20\u5927\u5C0F",width:"400px","close-on-click-modal":!1,"show-close":!0},{footer:d(()=>[y("span",Qu,[r(o(P),{onClick:u[5]||(u[5]=l=>_.value=!1)},{default:d(()=>u[19]||(u[19]=[h("\u53D6\u6D88")])),_:1,__:[19]}),r(o(P),{type:"primary",onClick:p},{default:d(()=>u[20]||(u[20]=[h("\u786E\u8BA4")])),_:1,__:[20]})])]),default:d(()=>[r(o(Ge),{model:b.value,"label-width":"100px"},{default:d(()=>[r(o(we),{label:"\u5BBD\u5EA6 (mm)"},{default:d(()=>[r(o(re),{modelValue:b.value.width,"onUpdate:modelValue":u[3]||(u[3]=l=>b.value.width=l),type:"number",min:"1",placeholder:"\u8BF7\u8F93\u5165\u7EB8\u5F20\u5BBD\u5EA6"},null,8,["modelValue"])]),_:1}),r(o(we),{label:"\u9AD8\u5EA6 (mm)"},{default:d(()=>[r(o(re),{modelValue:b.value.height,"onUpdate:modelValue":u[4]||(u[4]=l=>b.value.height=l),type:"number",min:"1",placeholder:"\u8BF7\u8F93\u5165\u7EB8\u5F20\u9AD8\u5EA6"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])]))}}),et=ye(Xu,[["__scopeId","data-v-5d4be75b"]]);export{et as default};
