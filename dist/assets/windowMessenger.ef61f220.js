import{ad as m}from"./index.6449b499.js";function E(r,e={}){return r.map(t=>({tid:`customModule.text.${t.id}`,type:"text",title:t.name,options:{title:t.name,field:t.id,testData:e&&e[t.id]||"",height:16,fontSize:9,fontWeight:"400",textAlign:"left",textContentVerticalAlign:"middle"}}))}function p(){return[{tid:"customModule.header",title:"\u5355\u636E\u8868\u5934",type:"text",options:{testData:"\u6253\u5370\u6A21\u677F",height:17,fontSize:16.5,fontWeight:"700",textAlign:"center",hideTitle:!0}},{tid:"customModule.type",title:"\u5355\u636E\u7C7B\u578B",type:"text",options:{testData:"\u6570\u636E\u6A21\u677F",height:16,fontSize:15,fontWeight:"700",textAlign:"center",hideTitle:!0}},{tid:"customModule.date",title:"\u4E1A\u52A1\u65E5\u671F",type:"text",options:{field:"date",testData:new Date().toLocaleDateString(),height:16,fontSize:9,fontWeight:"400",textAlign:"left",textContentVerticalAlign:"middle"}}]}function T(r,e={}){return[{tid:"customModule.fieldTable",title:"\u5B57\u6BB5\u6570\u636E\u8868",type:"table",options:{field:"table",tableHeaderRepeat:"first",tableFooterRepeat:"last",fields:r.map(t=>({text:t.name,field:t.id}))},editable:!0,columnDisplayEditable:!0,columnDisplayIndexEditable:!0,columnTitleEditable:!0,columnResizable:!0,columnAlignEditable:!0,isEnableEditField:!0,isEnableContextMenu:!0,isEnableInsertRow:!0,isEnableDeleteRow:!0,isEnableInsertColumn:!0,isEnableDeleteColumn:!0,isEnableMergeCell:!0,columns:[[{title:"\u5B57\u6BB5\u6F14\u793A",field:"demo",align:"center",width:100},{title:"\u5B57\u6BB5\u540D\u79F0",field:"name",align:"center",width:100},{title:"\u5B57\u6BB5\u7C7B\u578B",field:"type",align:"center",width:100},{title:"\u5B57\u6BB5\u503C",field:"value",align:"center",width:100},{title:"\u5B57\u6BB5\u503C",field:"632313",align:"center",width:100}]]}]}function w(){return[{tid:"customModule.customText",title:"\u81EA\u5B9A\u4E49\u6587\u672C",type:"text",options:{testData:"\u81EA\u5B9A\u4E49\u6587\u672C\u5185\u5BB9",height:16,fontSize:9,fontWeight:"400",textAlign:"left"}},{tid:"customModule.longText",title:"\u957F\u6587\u672C",type:"longText",options:{field:"longText",width:200,testData:"\u8FD9\u662F\u4E00\u6BB5\u53EF\u4EE5\u81EA\u52A8\u6362\u884C\u7684\u957F\u6587\u672C\uFF0C\u652F\u6301\u5206\u9875\u663E\u793A\u6216\u4E0D\u5206\u9875\u663E\u793A\uFF0C\u9002\u5408\u6253\u5370\u8F83\u957F\u7684\u6587\u5B57\u8BF4\u660E\u6216\u6761\u6B3E\u7B49\u5185\u5BB9\u3002"}},{tid:"customModule.printDate",title:"\u6253\u5370\u65F6\u95F4",type:"text",options:{field:"printDate",testData:new Date().toLocaleString(),height:16,fontSize:9,fontWeight:"400",textAlign:"left",textContentVerticalAlign:"middle"}},{tid:"customModule.operator",title:"\u64CD\u4F5C\u4EBA\u5458",type:"text",options:{field:"operator",testData:"\u7BA1\u7406\u5458",height:16,fontSize:9,fontWeight:"400",textAlign:"left",textContentVerticalAlign:"middle"}}]}function S(r,e={}){return function(t){var i=function(n){n.removePrintElementTypes("customModule"),n.addPrintElementTypes("customModule",[new m.exports.hiprint.PrintElementTypeGroup("\u5B57\u6BB5\u5143\u7D20",E(r,e)),new m.exports.hiprint.PrintElementTypeGroup("\u5355\u636E\u8868\u5934",p()),new m.exports.hiprint.PrintElementTypeGroup("\u8868\u683C\u6570\u636E",T(r,e)),new m.exports.hiprint.PrintElementTypeGroup("\u5176\u4ED6\u5143\u7D20",w())])};return{addElementTypes:i}}}const g={TEST_DATA:"testData",RECORD_DATA:"recordData",FIELD_SAMPLE:"fieldSample",EMPTY:"empty"};class D{constructor(){this.debugMode=!1}setDebugMode(e=!0){this.debugMode=e}_debug(e,t=null){this.debugMode&&console.log(`[PrintDataPreparer] ${e}`,t||"")}prepareSinglePrintData(e,t={}){const{includeTableData:i=!0,preferTestData:n=!0}=t;this._debug("\u5F00\u59CB\u51C6\u5907\u5355\u6761\u8BB0\u5F55\u6253\u5370\u6570\u636E",{templateData:e,options:t});let s={},a=g.EMPTY;if(n&&e.testData&&Object.keys(e.testData).length>0)s={...e.testData},a=g.TEST_DATA,this._debug("\u4F7F\u7528\u6D4B\u8BD5\u6570\u636E",s);else if(e.recordsData&&e.recordsData.length>0){const d=e.recordsData[0];s=this._extractRecordData(d),a=g.RECORD_DATA,this._debug("\u4F7F\u7528\u7B2C\u4E00\u6761\u8BB0\u5F55\u6570\u636E",s)}else this._debug("\u6CA1\u6709\u53EF\u7528\u6570\u636E\uFF0C\u4F7F\u7528\u7A7A\u5BF9\u8C61");return i&&(s.table=this._prepareTableData(e,a)),this._debug("\u5355\u6761\u8BB0\u5F55\u6253\u5370\u6570\u636E\u51C6\u5907\u5B8C\u6210",{dataType:a,printData:s}),s}prepareMultiplePrintData(e,t=[],i={}){const{includeTableData:n=!0,maxRecords:s=100}=i;if(this._debug("\u5F00\u59CB\u51C6\u5907\u591A\u6761\u8BB0\u5F55\u6253\u5370\u6570\u636E",{recordCount:t.length,options:i}),!t||t.length===0)return this._debug("\u6CA1\u6709\u9009\u4E2D\u7684\u8BB0\u5F55\uFF0C\u8FD4\u56DE\u7A7A\u6570\u7EC4"),[];const a=t.slice(0,s);t.length>s&&console.warn(`\u8BB0\u5F55\u6570\u91CF\u8D85\u8FC7\u9650\u5236\uFF0C\u53EA\u5904\u7406\u524D ${s} \u6761\u8BB0\u5F55`);const d=a.map((u,l)=>{this._debug(`\u5904\u7406\u7B2C ${l+1} \u6761\u8BB0\u5F55`,u);const o=this._extractRecordData(u),f={...o};return n&&(f.table=[o]),f});return this._debug("\u591A\u6761\u8BB0\u5F55\u6253\u5370\u6570\u636E\u51C6\u5907\u5B8C\u6210",{processedCount:d.length,printDataArray:d}),d}_extractRecordData(e){if(!e)return{};const t={...e};return delete t.recordId,delete t.field,t}_prepareTableData(e,t){switch(t){case g.TEST_DATA:return[e.testData];case g.RECORD_DATA:if(e.recordsData&&e.recordsData.length>0){const i=e.recordsData[0];return[this._extractRecordData(i)]}return[];case g.FIELD_SAMPLE:return[];default:return[]}}validatePrintData(e){const t={isValid:!1,errors:[],warnings:[],dataInfo:{}};try{if(!e)return t.errors.push("\u6253\u5370\u6570\u636E\u4E3A\u7A7A"),t;if(Array.isArray(e))t.dataInfo.type="array",t.dataInfo.count=e.length,e.length===0?t.warnings.push("\u6253\u5370\u6570\u636E\u6570\u7EC4\u4E3A\u7A7A"):e.forEach((i,n)=>{(!i||typeof i!="object")&&t.errors.push(`\u7B2C ${n+1} \u6761\u8BB0\u5F55\u6570\u636E\u65E0\u6548`)});else if(typeof e=="object")t.dataInfo.type="object",t.dataInfo.fieldCount=Object.keys(e).length,Object.keys(e).length===0&&t.warnings.push("\u6253\u5370\u6570\u636E\u5BF9\u8C61\u4E3A\u7A7A");else return t.errors.push("\u6253\u5370\u6570\u636E\u7C7B\u578B\u65E0\u6548\uFF0C\u5E94\u4E3A\u5BF9\u8C61\u6216\u6570\u7EC4"),t;return t.isValid=t.errors.length===0,this._debug("\u6253\u5370\u6570\u636E\u9A8C\u8BC1\u5B8C\u6210",t),t}catch(i){return t.errors.push(`\u9A8C\u8BC1\u8FC7\u7A0B\u51FA\u9519: ${i.message}`),t}}}function b(r=!1){const e=new D;return e.setDebugMode(r),e}const c={DESIGNER_READY:"DESIGNER_READY",INIT_TEMPLATE_DATA:"INIT_TEMPLATE_DATA",TEMPLATE_SAVED:"TEMPLATE_SAVED"},h={WAITING:"waiting",CONNECTED:"connected",TIMEOUT:"timeout",ERROR:"error"};class A{constructor(){this.childWindow=null,this.messageListener=null,this.timeoutId=null,this.dataSent=!1,this.status=h.WAITING,this.onStatusChange=null}openWindowAndSendData(e,t,i={}){const{windowFeatures:n="width=1200,height=800",timeout:s=8e3,onStatusChange:a=null}=i;return this.onStatusChange=a,this.dataSent=!1,this.status=h.WAITING,new Promise((d,u)=>{try{if(this.childWindow=window.open(e,"_blank",n),!this.childWindow||this.childWindow.closed||typeof this.childWindow.closed>"u"){this.status=h.ERROR,this._notifyStatusChange(),u(new Error("\u5F39\u7A97\u88AB\u6D4F\u89C8\u5668\u963B\u6B62\uFF0C\u8BF7\u5141\u8BB8\u5F39\u7A97\u540E\u91CD\u8BD5"));return}const l=()=>{if(this.dataSent){console.log("\u6570\u636E\u5DF2\u53D1\u9001\uFF0C\u8DF3\u8FC7\u91CD\u590D\u53D1\u9001");return}try{if(this.childWindow.closed){console.log("\u76EE\u6807\u7A97\u53E3\u5DF2\u5173\u95ED\uFF0C\u53D6\u6D88\u53D1\u9001\u6570\u636E"),this.status=h.ERROR,this._notifyStatusChange(),u(new Error("\u76EE\u6807\u7A97\u53E3\u5DF2\u5173\u95ED"));return}this.childWindow.postMessage({type:c.INIT_TEMPLATE_DATA,data:t,timestamp:new Date().getTime()},"*"),this.dataSent=!0,this.status=h.CONNECTED,this._notifyStatusChange(),console.log("\u6570\u636E\u5DF2\u53D1\u9001\u5230\u5B50\u7A97\u53E3"),d({success:!0,message:"\u6570\u636E\u53D1\u9001\u6210\u529F"})}catch(o){this.status=h.ERROR,this._notifyStatusChange(),console.error("\u53D1\u9001\u6570\u636E\u5230\u5B50\u7A97\u53E3\u5931\u8D25:",o),u(new Error("\u53D1\u9001\u6570\u636E\u5931\u8D25: "+(o.message||String(o))))}};this.messageListener=o=>{o.source===this.childWindow&&o.data&&o.data.type===c.DESIGNER_READY&&!this.dataSent&&(console.log("\u6536\u5230\u5B50\u7A97\u53E3\u51C6\u5907\u5C31\u7EEA\u6D88\u606F"),l(),this._cleanup())},window.addEventListener("message",this.messageListener),this.timeoutId=setTimeout(()=>{this.dataSent||(console.log("\u8D85\u65F6\u53D1\u9001\u6570\u636E\u5230\u5B50\u7A97\u53E3"),l()),this._cleanup()},s)}catch(l){this.status=h.ERROR,this._notifyStatusChange(),console.error("\u6253\u5F00\u5B50\u7A97\u53E3\u5931\u8D25:",l),u(new Error("\u6253\u5F00\u5B50\u7A97\u53E3\u5931\u8D25: "+(l.message||String(l))))}})}listenForMessages(e){const t=i=>{try{i.data&&i.data.type===c.TEMPLATE_SAVED&&(console.log("\u6536\u5230\u5B50\u7A97\u53E3\u53D1\u9001\u7684\u6A21\u677F\u6570\u636E"),e(i.data))}catch(n){console.error("\u5904\u7406\u5B50\u7A97\u53E3\u6D88\u606F\u5931\u8D25:",n)}};return window.addEventListener("message",t),()=>{window.removeEventListener("message",t)}}_cleanup(){this.messageListener&&(window.removeEventListener("message",this.messageListener),this.messageListener=null),this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)}_notifyStatusChange(){this.onStatusChange&&this.onStatusChange(this.status)}destroy(){this._cleanup(),this.childWindow=null,this.onStatusChange=null}}class _{constructor(){this.messageListener=null,this.dataReceived=!1,this.onDataReceived=null,this.timeout=12e3,this.timeoutId=null}initialize(e,t={}){const{timeout:i=12e3}=t;if(this.onDataReceived=e,this.timeout=i,this.dataReceived=!1,!window.opener||window.opener.closed)throw console.warn("\u6CA1\u6709\u7236\u7A97\u53E3\uFF0C\u53EF\u80FD\u662F\u76F4\u63A5\u8BBF\u95EE\u7684\u5B50\u7A97\u53E3"),new Error("\u8BF7\u4ECE\u4E3B\u9875\u9762\u6253\u5F00\u6B64\u7A97\u53E3");this.messageListener=this._handleMessageFromParent.bind(this),window.addEventListener("message",this.messageListener),this._sendReadyMessage(),this.timeoutId=setTimeout(()=>{if(!this.dataReceived)throw console.error("\u63A5\u6536\u6570\u636E\u8D85\u65F6"),new Error("\u672A\u80FD\u63A5\u6536\u5230\u6570\u636E\uFF0C\u8BF7\u8FD4\u56DE\u4E0A\u4E00\u9875\u91CD\u8BD5")},this.timeout)}_sendReadyMessage(){try{window.opener.postMessage({type:c.DESIGNER_READY,timestamp:new Date().getTime()},"*"),console.log("\u5DF2\u5411\u7236\u7A97\u53E3\u53D1\u9001\u51C6\u5907\u5C31\u7EEA\u6D88\u606F")}catch(e){console.error("\u53D1\u9001\u51C6\u5907\u5C31\u7EEA\u6D88\u606F\u5931\u8D25:",e)}}_handleMessageFromParent(e){try{console.log("\u6536\u5230\u6765\u81EA\u7236\u7A97\u53E3\u7684\u6D88\u606F:",e.data),e.data&&e.data.type===c.INIT_TEMPLATE_DATA&&e.data.data&&!this.dataReceived?(console.log("\u63A5\u6536\u5230\u521D\u59CB\u5316\u6570\u636E"),this.dataReceived=!0,this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null),this.onDataReceived&&this.onDataReceived(e.data.data)):e.data&&e.data.type===c.INIT_TEMPLATE_DATA&&this.dataReceived&&console.log("\u6570\u636E\u5DF2\u63A5\u6536\uFF0C\u8DF3\u8FC7\u91CD\u590D\u5904\u7406")}catch(t){throw console.error("\u5904\u7406\u7236\u7A97\u53E3\u6D88\u606F\u5931\u8D25:",t),new Error("\u5904\u7406\u6570\u636E\u5931\u8D25: "+(t.message||String(t)))}}sendDataToParent(e,t=c.TEMPLATE_SAVED){return new Promise((i,n)=>{try{if(!window.opener||window.opener.closed){n(new Error("\u6CA1\u6709\u7236\u7A97\u53E3\u53EF\u4EE5\u53D1\u9001\u6570\u636E"));return}const s={type:t,...e,timestamp:new Date().getTime()};window.opener.postMessage(s,"*"),console.log("\u6570\u636E\u5DF2\u53D1\u9001\u5230\u7236\u7A97\u53E3"),i({success:!0,message:"\u6570\u636E\u53D1\u9001\u6210\u529F"})}catch(s){console.error("\u53D1\u9001\u6570\u636E\u5230\u7236\u7A97\u53E3\u5931\u8D25:",s),n(new Error("\u53D1\u9001\u6570\u636E\u5931\u8D25: "+(s.message||String(s))))}})}destroy(){this.messageListener&&(window.removeEventListener("message",this.messageListener),this.messageListener=null),this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null),this.onDataReceived=null}}function R(){return new A}function M(){return new _}export{h as C,R as a,S as b,b as c,M as d};
